name: Descargar JSON SEACE (últimos 3 meses)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  fetch_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (chék-aut)
        uses: actions/checkout@v4

      - name: Descargar JSON de los últimos 3 meses
        run: |
          set -e
          mkdir -p data

          for i in 0 1 2; do
            YEAR=$(date -u -d "-$i month" +%Y)
            MONTH=$(date -u -d "-$i month" +%m)

            echo "Descargando $YEAR-$MONTH ..."

            URL="https://contratacionesabiertas.oece.gob.pe/api/v1/file/seace_v3/json/$YEAR/$MONTH"
            FILE="data/seace_v3_${YEAR}_${MONTH}.json"

            curl -L -sS -X GET \
              "$URL" \
              -H "accept: */*" \
              -o "$FILE"

            # Validar que el archivo no esté vacío
            test -s "$FILE"

            echo "OK: $FILE"
          done

      - name: Commit de los JSON al repo (kó-mit)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/*.json
          git commit -m "Actualizar JSON SEACE últimos 3 meses" || exit 0
          git push
