name: Descargar JSON SEACE (últimos 3 meses) y subir a BigQuery

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  fetch_json:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Descargar el repo al runner (GitHub Actions necesita esto para trabajar)
      - name: Checkout (chék-aut)
        uses: actions/checkout@v4

      # Paso 2: Limpiar la carpeta data localmente (en el runner)
      # Nota: la eliminación real en el repo se "registra" cuando hacemos git add -A data y commit.
      - name: Limpiar carpeta data (y marcar borrado en Git)
        run: |
          set -e
          mkdir -p data
          # Borra todo lo anterior (solo dentro de data)
          rm -f data/*.json data/*.zip || true
          rm -rf data/tmp || true

      # Paso 3: Calcular los últimos 3 meses y descargar el ZIP de cada mes
      # Luego extraer el contenido y mover todos los .json a /data
      - name: Descargar ZIP, verificar, extraer JSON (últimos 3 meses)
        run: |
          set -e
          mkdir -p data/tmp

          for i in 0 1 2; do
            YEAR=$(date -u -d "-$i month" +%Y)
            MONTH=$(date -u -d "-$i month" +%m)

            echo "=== Mes: $YEAR-$MONTH ==="

            URL="https://contratacionesabiertas.oece.gob.pe/api/v1/file/seace_v3/json/$YEAR/$MONTH"
            ZIP="data/seace_v3_${YEAR}_${MONTH}.zip"

            # 1) Descargar ZIP
            curl -L -sS -X GET "$URL" -H "accept: */*" -o "$ZIP"
            test -s "$ZIP"

            # 2) Verificar que sea ZIP (no HTML, no error)
            echo "Tipo de archivo:"
            file "$ZIP"

            # 3) Ver contenido del ZIP (para confirmar que hay JSON)
            echo "Contenido del ZIP:"
            unzip -l "$ZIP" | head -n 50

            # 4) Extraer
            unzip -o "$ZIP" -d "data/tmp/$YEAR-$MONTH"
          done

          # 5) Mover TODOS los JSON extraídos a data/
          find data/tmp -type f -name "*.json" -print -exec mv -f {} data/ \;

          # 6) Limpiar temporales y zips (si no quieres guardarlos)
          rm -rf data/tmp
          rm -f data/*.zip

          echo "=== Archivos finales en data/ ==="
          ls -lh data/

      # Paso 4: Autenticación con Google Cloud usando un Secret del repo
      # Requisito: Debes tener creado el secret GCP_SA_KEY con el JSON del Service Account.
      - name: Autenticación Google Cloud (gú-gol klaud)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Paso 5: Instalar gcloud para poder usar bq (bi-kiú)
      - name: Setup gcloud (sét-ap jí-klaud)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: heroic-ruler-481618-e5

      # Paso 6: Subir cada archivo JSON a BigQuery como una tabla con su nombre
      # Tabla = nombre del archivo sin .json. Ej: seace_v3_2026_01.json -> tabla seace_v3_2026_01
      # Nota: esto asume NEWLINE_DELIMITED_JSON (NDJSON). Si tus JSON no son NDJSON, fallará.
      - name: Subir JSON a BigQuery (bi-kiú) tabla por archivo
        run: |
          set -e

          PROJECT_ID="heroic-ruler-481618-e5"
          DATASET_ID="github_actions"

          echo "=== Archivos a cargar a BigQuery ==="
          ls -lh data/*.json

          for f in data/*.json; do
            base=$(basename "$f" .json)
            table="$base"

            echo "===================================="
            echo "Cargando archivo: $f"
            echo "Tabla destino: ${PROJECT_ID}:${DATASET_ID}.${table}"

            bq load \
              --project_id="$PROJECT_ID" \
              --source_format=NEWLINE_DELIMITED_JSON \
              --autodetect \
              --replace \
              "${DATASET_ID}.${table}" \
              "$f"

            echo "OK: ${DATASET_ID}.${table}"
          done

      # Paso 7: Commit al repo incluyendo borrados (esto elimina del repo los archivos viejos)
      # Importante: git add -A data incluye nuevos, modificados y eliminados dentro de /data
      - name: Commit al repo (kó-mit) incluyendo borrados
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Esto incluye nuevos, modificados y borrados
          git add -A data

          echo "=== Git status (para ver qué va al commit) ==="
          git status --porcelain

          git commit -m "Actualizar JSON SEACE últimos 3 meses" || exit 0
          git push
