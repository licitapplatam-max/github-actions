name: Descargar JSON SEACE (últimos 3 meses)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  fetch_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (chék-aut)
        uses: actions/checkout@v4

      - name: Limpiar carpeta data (y marcar borrado en Git)
        run: |
          set -e
          mkdir -p data
          # Borra todo lo anterior (solo dentro de data)
          rm -f data/*.json data/*.zip || true
          rm -rf data/tmp || true

      - name: Descargar ZIP, verificar, extraer JSON (últimos 3 meses)
        run: |
          set -e
          mkdir -p data/tmp

          for i in 0 1 2; do
            YEAR=$(date -u -d "-$i month" +%Y)
            MONTH=$(date -u -d "-$i month" +%m)

            echo "=== Mes: $YEAR-$MONTH ==="

            URL="https://contratacionesabiertas.oece.gob.pe/api/v1/file/seace_v3/json/$YEAR/$MONTH"
            ZIP="data/seace_v3_${YEAR}_${MONTH}.zip"

            # 1) Descargar ZIP
            curl -L -sS -X GET "$URL" -H "accept: */*" -o "$ZIP"
            test -s "$ZIP"

            # 2) Verificar que sea ZIP (no HTML, no error)
            echo "Tipo de archivo:"
            file "$ZIP"

            # 3) Ver contenido del ZIP (para confirmar que hay JSON)
            echo "Contenido del ZIP:"
            unzip -l "$ZIP" | head -n 50

            # 4) Extraer
            unzip -o "$ZIP" -d "data/tmp/$YEAR-$MONTH"
          done

          # 5) Mover TODOS los JSON extraídos a data/
          find data/tmp -type f -name "*.json" -print -exec mv -f {} data/ \;

          # 6) Limpiar temporales y zips (si no quieres guardarlos)
          rm -rf data/tmp
          rm -f data/*.zip

          echo "=== Archivos finales en data/ ==="
          ls -lh data/

      - name: Commit al repo (kó-mit) incluyendo borrados
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Esto es LA CLAVE: incluye nuevos, modificados y borrados
          git add -A data

          echo "=== Git status (para ver qué va al commit) ==="
          git status --porcelain

          git commit -m "Actualizar JSON SEACE últimos 3 meses" || exit 0
          git push
