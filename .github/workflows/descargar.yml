name: Descargar XLSX y subir a Google Drive

on:
  workflow_dispatch: {}

jobs:
  fetch_xlsx:
    runs-on: ubuntu-latest

    steps:
      - name: Autenticación Google (gú-gol)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Instalar dependencias
        run: |
          pip install --quiet google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Descargar XLSX
        run: |
          mkdir -p data

          # EJEMPLO: cambia la URL real del XLSX
          curl -L -o data/seace_2026_01.xlsx \
            "URL_REAL_DEL_XLSX_AQUI"

          ls -lh data/

      - name: Subir XLSX a Google Drive
        run: |
          python - <<'PY'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import os

          FOLDER_ID = "1wuqTZSGIS-qBVy3nSYucgxJxHi9TPTEt"

          creds = service_account.Credentials.from_service_account_file(
              os.environ["GOOGLE_APPLICATION_CREDENTIALS"],
              scopes=["https://www.googleapis.com/auth/drive"]
          )

          service = build("drive", "v3", credentials=creds)

          for file in os.listdir("data"):
              if file.endswith(".xlsx"):
                  media = MediaFileUpload(
                      f"data/{file}",
                      mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                  )

                  file_metadata = {
                      "name": file,
                      "parents": [FOLDER_ID]
                  }

                  uploaded = service.files().create(
                      body=file_metadata,
                      media_body=media,
                      fields="id"
                  ).execute()

                  print(f"Subido: {file} -> ID {uploaded['id']}")
          PY
