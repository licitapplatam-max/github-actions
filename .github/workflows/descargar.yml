name: Descargar CSV SEACE y subir a BigQuery (1 mes)

on:
  workflow_dispatch: {}

jobs:
  load_csv_bq:
    runs-on: ubuntu-latest

    steps:
      # 1) Autenticaci√≥n Google
      - name: Auth Google
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2) Setup gcloud + bq
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: heroic-ruler-481618-e5

      # 3) Descargar CSV (1 mes)
      - name: Descargar CSV SEACE
        run: |
          set -e
          mkdir -p data

          curl -L -f \
            "https://contratacionesabiertas.oece.gob.pe/api/v1/file/seace_v3/csv/2026/01" \
            -o data/seace_v3_2026_01.csv

          ls -lh data/
          test -s data/seace_v3_2026_01.csv

      # 4) Subir a BigQuery
      - name: Cargar CSV a BigQuery
        run: |
          set -e

          PROJECT_ID="heroic-ruler-481618-e5"
          DATASET="github_actions"
          TABLE="seace_v3_2026_01"

          bq load \
            --project_id="$PROJECT_ID" \
            --source_format=CSV \
            --autodetect \
            --skip_leading_rows=1 \
            --replace \
            "${DATASET}.${TABLE}" \
            data/seace_v3_2026_01.csv
